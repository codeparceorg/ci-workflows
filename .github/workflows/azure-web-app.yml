# .github/workflows/node-build.yml
name: Deploy to Azure Arquitecture


on:
  workflow_call:

jobs:
  deploy-azure-static-web-app:
    runs-on: ubuntu-latest
    name: Static Web App

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0 
          
      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Download build artifact
        uses: actions/download-artifact@v4
        with:
          name: web-build
          path: dist

      - name: Download json artifact
        uses: actions/download-artifact@v4
        with:
          name: static-web-app-json
          path: secret

      - name: Install SWA CLI
        run: npm install -g @azure/static-web-apps-cli 

      - name: Deploy Static Web App
        run: |
          ENV_NAME=$([ "$GITHUB_REF_NAME" = "main" ] && echo "production" || echo "$GITHUB_REF_NAME")
          FILE_JSON="secret/static-web-app-json.json"
          API_KEY=$(jq -r '.properties.apiKey' $FILE_JSON)
          swa deploy ./dist --deployment-token $API_KEY --env $ENV_NAME
